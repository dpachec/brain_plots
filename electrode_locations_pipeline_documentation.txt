Documentation of how to extract MNI location of electrodes based on the post CT and MRI scans. 
Requirements: 

We first need a mainPath with subfolders s01, s02, ... sN
In each subfolder include MRI and CT scans s01_MRI.nii and s01_CT.nii.gz (to create the list of s01_CT.nii.gz open all files in 3Dslicer with DICOM database and export the corresponding CTs with the electrodes, file needs to be saved in .nii.gz format and with compression (check compressed checkbox when exporting)

1)	Perform ACPC transform on the MRI scans. This can be done using the stolk method, or the 3D slicer method. To do it with the 3D slicer method, use the code in create_fiducials_acpc.py to create the ACPC fiducials. Locate them in their correspondent positions by dragging fiducials in the 3D view and using the sliced views. Anterior comissure, posterior comissure and Interhemispherical point should be defined. Check video 2 of the stolk paper to see example. See images in the reference_images folders to see more examples- When ACPC fiducial positions are determined run the acpc_transformation.py script to perform the transformation (ctrl+G). The file needs to be saved in the format sXX_MR_acpc.nii (uncheck the compress box). Note that .nii and not .nii.gz should be used

2)	Process ACPC transformed MRI with FreeSurfer. Use the script freesurfer_processing.m


After these two initial steps, two options are available for co-registration: 1) 3D slicer and 2) SPM (Stolk et al., 2018 pipeline)

3D slicer
1)	Import the Freesurfer processed MRI (located in subject/freesurfer/mri/T1.mgz) into 3D slicer 
2)	Import the CT scans into 3D slicer 
3)	Corregister the CT scan and the freesurfer processed MRI 
a.	Parameters are important here. Module to use is General Registration (Brains). Look for this module using the lupa in 3D licer 
b.	Fixed image volume = T1
c.	Moving image volume = CT- 
d.	If CT is misaligned, it has to be centered so that it overlaps substantially with the MRI scan. This can be done by selecting the CT and right click > Edit Properties.  Volume information tab, change the image origin values. Percentage of samples (0.02). The default is 0.002, and does not produce good results. Output settings: Slicer linear transform > Create new LinearTransform. Registration phases: select only Rigid 6DOF 
e.	 Check that the results are correct both in the 3D view and in the slicer views

Stolk et al., 2018
1)	Use the script spm_corregistration.m to corregister the MRI and CT scans using SPM. Fist, convert all raw CT scans into CTF (video 3 of stolk) and convert to ACPC. This can be found in the first 3 code blocks of spm_corregistration.m. Then use the Freesurfer processed MRI (subject/freesurfer/mri/T1.mgz) to generate the files s01_CT_acpc_f.nii ... This can be done in a loop if all subjects CT scans in ACPC format are first saved. 


After coregistration perform electrode localization
Electrode localization
4)	Localize the electrodes manually using 3D slicer. For every subject, import the sXX_CT_acpc_f.nii file contained the fused CT and MRI scans produced with SPM. Export the coordinates of all electrodes. A new curve with two points needs to be created (start and end of electrode). Load the create_fiducials.py file into 3D slicer python console using CTRL+G. Specify the first and the last contact points in the electrode. Then call add_fiducials_along_line(string: node_name (e.g. “H”), 10). 

5)	Export all electrodes to a csv file, using the functoin export_all_fiducials, also included in the create_fiducials.py file. Specify the main path of all subjects (a main folder with subfolders "s01", "s02", "s0N"). The script will find the name of the current subject based on the subject name extracted from the first node in the 3D slicer hierarchy (below scene, the typical first node will be "s02_CT_acpc_f") and it will export all of them. Make sure to specify the main path with // and not backlash in the other direction, because the string gets confused in the python console if using the “\\” version. 

6)	To convert to MNI space, extract the affine matrix transform generated by freesurfer. Use the script electrode_conversion_affine.m to peform this conversion. Check the mne version here for reference: Section FreeSurfer’s MNI affine transformation. https://mne.tools/1.0/auto_tutorials/forward/50_background_freesurfer_mne.html 


7) To extract the electrode labels in subject space, use the file fiducials.csv, which are in ACPC coodrinates. IMPORTANTLY, check the following functoin script generate_electable_V3.m created by fieltrip team to assess how they process the electrodes in native space (around the middle of the script). There, it is clear that to obtain the freesurfer individual atlases, we need to go into the subject specific freesurfer folder, and then   '/mri/aparc+aseg.mgz' to get Desikan-Killiany (+volumetric) or  '/mri/aparc.a2009s+aseg.mgz' to get Destrieux (+volumetric), and that the coordinate system is in ACPC


for more info about subject specific atlases in freesurfer (i.e., Destrieux). https://www.fieldtriptoolbox.org/template/atlas/
https://www.fieldtriptoolbox.org/faq/how_can_i_determine_the_anatomical_label_of_a_source/



Tip: when the anatomical data and electrode info files are ready (raw data), proceess them as a DICOM database in 3D slicer, and then export the ACPC transformed MRI and raw CT's into the working folder